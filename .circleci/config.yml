orbs:
  anchore: anchore/anchore-engine@1.6.0

version: 2.1
jobs:
  lint:
    docker:
      # Use the same Docker base as the project
      - image: python:3.7.3-stretch
    
    working_directory: ~/repo
    
    steps:
      - checkout
    
      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
    
      - run:
          name: install dependencies
          command: |
            python3 -m venv venv
            . venv/bin/activate
            make install
            # Install hadolint
            wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 && chmod +x /bin/hadolint
      - save_cache:
           paths:
             - ./venv
           key: v1-dependencies-{{ checksum "requirements.txt" }}
    
          # run lint!
      - run:
          name: run lint
          command: |
            . venv/bin/activate
            make lint
  local_image_scan:
    executor: anchore/anchore_engine
    steps:
      - setup_remote_docker
      - checkout
      - run:
          name: build image
          command: 'docker build -t "test/housepricemlapi:latest" .'
      - anchore/analyze_local_image:
          dockerfile_path: ./Dockerfile
          image_name: 'test/housepricemlapi:latest'
          policy_bundle_file_path: .circleci/.anchore/policy_bundle.json
          policy_failure: true
          timeout: '500'
      - anchore/parse_reports
      - store_artifacts:
          path: anchore-reports

  upload_image:
    docker:
      - image: circleci/buildpack-deps:stretch
        auth:
          username: beardyc
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - setup_remote_docker
      - run: |
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
          TAG=0.1.$CIRCLE_BUILD_NUM
          docker build -t $DOCKER_USERNAME/housepricemlapi:$TAG .
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USER --password-stdin hub.docker.com
          docker push $DOCKER_USERNAME/housepricemlapi:$TAG   

workflows:
  default:
    jobs:
      - lint
      #- local_image_scan
      - upload_image
      #    requires: [lin, local_image_scan]

